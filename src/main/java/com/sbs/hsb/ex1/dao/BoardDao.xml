<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sbs.hsb.ex1.dao.BoardDao">

	<insert id="doApplyForCreateBoard" useGeneratedKeys="true" keyProperty="id">
		INSERT
		INTO board
		SET regDate = NOW(),
		updateDate = NOW(),
		code = #{code},
		name = #{name},
		memberId = #{memberId}
	</insert>
	
	<select id="getBoardId" resultType="int">
		SELECT id
		FROM board
		WHERE name = #{name}
	</select>
	
	<update id="docApplyConfirm">
		UPDATE boardApplyDoc
		SET
		updateDate = NOW(),
		applyStatus = 1,
		boardId = #{boardId}
		WHERE memberId = #{memberId}
		AND name = #{name}
	</update>
	
	<update id="doBoardReject">
		UPDATE boardApplyDoc
		SET
		updateDate = NOW(),
		delStatus = 1
		WHERE memberId = #{memberId}
		AND name = #{name}
		AND boardId = #{boardId}
	</update>
	
	<insert id="setBoardApplyDoc" useGeneratedKeys="true" keyProperty="id">
		INSERT
		INTO boardApplyDoc
		SET regDate = NOW(),
		updateDate = NOW(),
		memberId = #{memberId},
		name = #{name},
		body = #{body}
	</insert>
	
	<select id="getBoardNameDupCount" resultType="int">
		SELECT COUNT(*) AS
		cnt
		FROM board
		WHERE name = #{name}
		AND delStatus = 0
	</select>
	
	<select id="getBoardApplyDocCount" resultType="int">
		SELECT COUNT(*) AS
		cnt
		FROM boardApplyDoc
		WHERE name = #{name}
	</select>
	
	
	<!-- 추후에 INNER JOIN 으로 탈퇴한 회원의 delStatus도 함께 비교하여 가져올것 -->
	<select id="getAllBoardApplyDocs" resultMap="boardApplyDoc">
		SELECT D.*,
		M.nickname AS extra__writer
		FROM boardApplyDoc AS D
		INNER JOIN member AS M
		ON D.memberId = M.id
		WHERE M.delStatus = 0
		AND D.delStatus = 0
		AND D.applyStatus = 0
	</select>
	
	
	<update id="doDelDocNameDup">
		UPDATE boardApplyDoc
		SET
		updateDate = NOW(),
		delStatus = 1
		WHERE name = #{name}
		AND applyStatus = 0
	</update>
	
		
	
	<resultMap type="BoardApplyDoc" id="boardApplyDoc">
		<id property="id" column="id" />
		<id property="regDate" column="regDate" />
		<id property="updateDate" column="updateDate" />
		<id property="delDate" column="delDate" />
		<id property="delStatus" column="delStatus" />
		<id property="applyStatus" column="applyStatus" />
		<id property="memberId" column="memberId" />
		<id property="name" column="name" />
		<id property="body" column="body" />
		<id property="boardId" column="boardId" />
		<association property="extra" javaType="map">
			<id property="writer" column="extra__writer" />
		</association>
	</resultMap>
</mapper>
